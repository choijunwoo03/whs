package com.example.pentestingplayground.controller;

import jakarta.servlet.http.HttpSession;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;

@Controller
public class FileUploadController {

    private static final String UPLOAD_DIR = System.getProperty("user.dir") + File.separator + "uploads";

    // 업로드 페이지
    @GetMapping("/upload")
    public String uploadPage(HttpSession session) {
        if (session.getAttribute("loginId") == null) {
            return "redirect:/login";
        }
        return "upload";  // upload.jsp
    }

    // 업로드 처리
    @PostMapping("/upload")
    public String handleFileUpload(@RequestParam("file") MultipartFile file, Model model, HttpSession session) {
        if (session.getAttribute("loginId") == null) {
            return "redirect:/login";
        }

        if (file.isEmpty()) {
            model.addAttribute("message", "파일이 선택되지 않았습니다.");
            return "uploadResult";
        }

        try {
            File dir = new File(UPLOAD_DIR);
            if (!dir.exists()) dir.mkdirs();

            File dest = new File(dir, file.getOriginalFilename());
            file.transferTo(dest);
            model.addAttribute("message", "파일 업로드 성공: " + dest.getAbsolutePath());
        } catch (IOException e) {
            model.addAttribute("message", "업로드 실패: " + e.getMessage());
        }

        return "uploadResult";  // 결과 출력 페이지
    }

    // 파일 목록 보기
    @GetMapping("/upload-list")
    public String showUploadList(Model model, HttpSession session) {
        if (session.getAttribute("loginId") == null) {
            return "redirect:/login";
        }

        File folder = new File(UPLOAD_DIR);
        String[] fileNames = folder.list();
        model.addAttribute("files", fileNames);
        return "uploadList";  // uploadList.jsp
    }

    // 파일 삭제
    @PostMapping("/delete")
    public String deleteFile(@RequestParam("filename") String filename, Model model, HttpSession session) {
        if (session.getAttribute("loginId") == null) {
            return "redirect:/login";
        }

        File file = new File(UPLOAD_DIR, filename);
        if (file.exists()) {
            if (file.delete()) {
                model.addAttribute("message", "파일 삭제 성공: " + filename);
            } else {
                model.addAttribute("message", "파일 삭제 실패: " + filename);
            }
        } else {
            model.addAttribute("message", "파일이 존재하지 않습니다: " + filename);
        }

        File folder = new File(UPLOAD_DIR);
        String[] fileNames = folder.list();
        model.addAttribute("files", fileNames);
        return "uploadList";
    }
}
